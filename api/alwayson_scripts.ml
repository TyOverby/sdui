open! Core
open Ppx_yojson_conv_lib.Yojson_conv.Primitives

module Ctrlnet = struct
  type arg =
    { enabled : bool
    ; module_ : string [@key "module"]
    ; model : string
    ; weight : float
    ; image : string
    ; lowvram : bool
    ; processor_res : int [@key "processor_res"]
    ; threshold_a : int [@key "threshold_a"]
    ; threshold_b : int [@key "threshold_b"]
    ; guidance_start : float [@key "guidance_start"]
    ; guidance_end : float [@key "guidance_end"]
    ; control_mode : string [@key "control_mode"]
    ; resize_mode : string [@key "resize_mode"]
    ; pixel_perfect : bool [@key "pixel_perfect"]
    }
  [@@deriving yojson_of, sexp]

  type t = { args : arg list } [@@deriving yojson_of, sexp]

  module Query = struct
    type t =
      { image : Image.t
      ; module_ : string option
      ; model : string
      ; weight : float
      ; guidance_start : float
      ; guidance_end : float
      }
    [@@deriving sexp, equal]

    let to_arg { image; module_; model; guidance_start; guidance_end; weight } =
      { args =
          [ { pixel_perfect = false
            ; control_mode = "Balanced"
            ; guidance_start
            ; guidance_end
            ; threshold_a = 64
            ; threshold_b = 64
            ; processor_res = 64
            ; lowvram = false
            ; resize_mode = "Just Resize"
            ; image = Image.to_string image
            ; weight
            ; model
            ; module_ = Option.value module_ ~default:"none"
            ; enabled = true
            }
          ]
      }
    ;;
  end
end

module Regional_prompter = struct
  type arg =
    { active : bool
    ; debug : bool
    ; mode : string
    ; matrix_mode : string
    ; mask_mode : string
    ; prompt_mode : string
    ; ratios : string
    ; base_ratios : string
    ; use_base : bool
    ; use_common : bool
    ; use_neg_common : bool
    ; calcmode : string
    ; not_change_and : bool
    ; lora_textencoder : string
    ; lora_unet : string
    ; threshold : string
    ; mask : string
    ; lora_stop_step : string
    ; lora_hires_sto_step : string
    ; flip : bool
    }
  [@@deriving yojson_of, sexp]

  let yojson_of_arg t =
    match yojson_of_arg t with
    | `Assoc list -> `List (List.unzip list |> Tuple2.get2)
    | other -> other
  ;;

  type t = { args : arg } [@@deriving yojson_of, sexp]

  let yojson_of_t _ =
    Yojson.Safe.from_string
      {| {"args":	[true,false,"Mask","Vertical","Mask","Prompt","1,1,1","",true,false,false,"Latent",false,"0","0","0",
      "data:image/png;base64,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" 
      ] } |}
  ;;

  (* 			{ "args":	[true,true,"Mask","Vertical","Mask","Prompt","1,1,1","0.2",true,false,false,"Attention",false,"0","0","0",
       "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAACWCAYAAABkW7XSAAAAAXNSR0IArs4c6QAABUFJREFUeF7t1tENwkAUA8HQWagMqIzSoAk+1mRSQGSNn6y7HT4CBAiMCNxGcopJgACBw2A5AgIEZgQM1kxVghIgYLDcAAECMwIGa6YqQQkQMFhugACBGQGDNVOVoAQIGCw3QIDAjIDBmqlKUAIEDJYbIEBgRsBgzVQlKAECBssNECAwI2CwZqoSlAABg+UGCBCYETBYM1UJSoCAwXIDBAjMCBismaoEJUDAYLkBAgRmBAzWTFWCEiBgsNwAAQIzAgZrpipBCRAwWG6AAIEZAYM1U5WgBAgYLDdAgMCMgMGaqUpQAgQMlhsgQGBGwGDNVCUoAQIGyw0QIDAjYLBmqhKUAAGD5QYIEJgRMFgzVQlKgIDBcgMECMwIGKyZqgQlQMBguQECBGYEDNZMVYISIGCw3AABAjMCBmumKkEJEDBYboAAgRkBgzVTlaAECBgsN0CAwIyAwZqpSlACBAyWGyBAYEbAYM1UJSgBAgbLDRAgMCNgsGaqEpQAAYPlBggQmBEwWDNVCUqAgMFyAwQIzAgYrJmqBCVAwGC5AQIEZgQM1kxVghIgYLDcAAECMwIGa6YqQQkQMFhugACBGQGDNVOVoAQIGCw3QIDAjIDBmqlKUAIEDJYbIEBgRsBgzVQlKAECBssNECAwI2CwZqoSlAABg+UGCBCYETBYM1UJSoCAwXIDBAjMCBismaoEJUDAYLkBAgRmBAzWTFWCEiBgsNwAAQIzAgZrpipBCRAwWG6AAIEZAYM1U5WgBAgYLDdAgMCMgMGaqUpQAgQMlhsgQGBGwGDNVCUoAQIGyw0QIDAjYLBmqhKUAAGD5QYIEJgRMFgzVQlKgIDBcgMECMwIGKyZqgQlQMBguQECBGYEDNZMVYISIGCw3AABAjMCBmumKkEJEDBYboAAgRkBgzVTlaAECBgsN0CAwIyAwZqpSlACBAyWGyBAYEbAYM1UJSgBAgbLDRAgMCNgsGaqEpQAAYPlBggQmBEwWDNVCUqAgMFyAwQIzAgYrJmqBCVAwGC5AQIEZgQM1kxVghIgYLBiN/A8z08s0k/jPN7vn/7Pz64lYLBifV9xsF73e6wFcaoCBivWzL8PVoxbnDEBgxUrzGDFChEnJWCwUnUch8GKFSJOSsBgpeowWLE6xIkJGKxYIV5YsULESQkYrFQdXlixOsSJCRisWCFeWLFCxEkJGKxUHV5YsTrEiQkYrFghXlixQsRJCRisVB1eWLE6xIkJGKxYIV5YsULESQkYrFQdXlixOsSJCRisWCFeWLFCxEkJGKxUHV5YsTrEiQkYrFghXlixQsRJCRisVB1eWLE6xIkJGKxYIV5YsULESQkYrFQdXlixOsSJCRisWCFeWLFCxEkJGKxUHV5YsTrEiQkYrFghXlixQsRJCRisVB1eWLE6xIkJGKxYIV5YsULESQkYrFQdXlixOsSJCRisWCFeWLFCxEkJGKxUHV5YsTrEiQkYrFghXlixQsRJCRisVB1eWLE6xIkJGKxYIV5YsULESQkYrFQdXlixOsSJCRisWCFeWLFCxEkJGKxUHV5YsTrEiQkYrFghXlixQsRJCRisVB1eWLE6xIkJGKxYIV5YsULESQkYrFQdXlixOsSJCRisWCFeWLFCxEkJGKxUHV5YsTrEiQkYrFghXlixQsRJCRisVB1eWLE6xIkJGKxYIV5YsULESQkYrFQdXlixOsSJCRisWCFeWLFCxEkJGKxUHV5YsTrEiQkYrFghXlixQsRJCRisVB1eWLE6xIkJGKxYIV5YsULESQkYrFQdXlixOsSJCXwBs8FpYimNQIgAAAAASUVORK5CYII=" *)

  module Query = struct
    type t =
      { ratios : string
      ; matrix_mode : [ `Horizontal | `Vertical | `Columns | `Rows ]
      }
    [@@deriving sexp, equal]

    let to_arg { ratios; matrix_mode } =
      let mode =
        match `Matrix with
        | `Matrix -> "Matrix"
        | `Mask -> "Mask"
        | `Prompt -> "Prompt"
      in
      let matrix_mode =
        match matrix_mode with
        | `Horizontal -> "Horizontal"
        | `Vertical -> "Vertical"
        | `Columns -> "Columns"
        | `Rows -> "Rows"
      in
      let calcmode =
        match `Attention with
        | `Attention -> "Attention"
        | `Latent -> "Latent"
      in
      { args =
          { active = true
          ; debug = true
          ; mode
          ; matrix_mode
          ; mask_mode = "Mask"
          ; prompt_mode = "Prompt"
          ; ratios
          ; base_ratios = "0.5"
          ; use_base = false
          ; use_common = true
          ; use_neg_common = false
          ; calcmode
          ; not_change_and = false
          ; lora_textencoder = "0"
          ; lora_unet = "0"
          ; threshold = "0"
          ; mask = ""
          ; lora_stop_step = "0"
          ; lora_hires_sto_step = "0"
          ; flip = false
          }
      }
    ;;
  end
end

type t =
  { controlnet : Ctrlnet.t option [@option]
  ; regional_prompter : Regional_prompter.t option [@option] [@key "Regional Prompter"]
  }
[@@deriving yojson_of, sexp]

let create ~ctrlnet ~regional_prompter () =
  let controlnet = Option.map ctrlnet ~f:Ctrlnet.Query.to_arg in
  let regional_prompter =
    Option.map regional_prompter ~f:Regional_prompter.Query.to_arg
  in
  match controlnet, regional_prompter with
  | None, None -> None
  | _, _ -> Some { controlnet; regional_prompter }
;;
